#!/usr/bin/env bash
set -euo pipefail

# Ensure tools are found when launched by Hyprland
export PATH="$HOME/.local/bin:$HOME/.cargo/bin:/usr/local/bin:/usr/bin:/bin"

# (optional) quick log if you want to debug launches
# LOG="${XDG_CACHE_HOME:-$HOME/.cache}/ss.log"; mkdir -p "$(dirname "$LOG")"; exec > >(tee -a "$LOG") 2>&1

# Pick a region
geom="$(slurp)" || exit 0  # Esc cancels cleanly

# Temp output file from Satty
tmp_png="$(mktemp --suffix=.png)"
trap 'rm -f "$tmp_png"' EXIT

# Capture → annotate in Satty → press Enter to save and exit
# Notes:
# - PPM is faster to pipe than PNG
# - Use --action-on-enter save-to-file (or --actions-on-enter on newer builds)
grim -g "$geom" -t ppm - \
  | satty --filename - \
          --fullscreen \
          --output-filename "$tmp_png" \
          --action-on-enter save-to-file \
          --early-exit

# Upload and copy URL
url="$(
  curl -sS \
    -H "authorization: MTc0MTQ3MjU1OTkzOQ==.ZGIxM2RlMDY5MjYwZDdlZTJhY2JhMzgwNGVhNmZmODUuMDU1ZGFlODgzNzk5ODNlNDc3YjUxY2FlZDA2NzU1ZTc3ZmZjN2RiNjVjYTU2NGM4NDhkMGZjMDVjY2QwZTQwNzVjODFkYzhkNWNiZGE0ZjJmNDc3ZjdiOWM5NjFhMTBkZGQ0OGZhZjg2YTcxZWI3N2NjZDZlMWFjNDJlYmQwNjA5ZWQxN2IwNDQxMDFmOTZkNTUwOWU0OGEyMzVhYWRlNA==" \
    -F "file=@${tmp_png}" \
    https://1m.cx/api/upload \
  | jq -r '.files[0].url'
)"
[ -n "$url" ] && printf '%s' "$url" | wl-copy
echo "${url:-upload failed}"